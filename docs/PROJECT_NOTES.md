# Документация проекта (рабочие заметки)

## Назначение
Проект реализует Telegram-бота для скачивания контента по ссылкам с подключаемыми провайдерами (YouTube, Instagram Reels, VK). Запросы от бота ставятся в очередь, а воркер скачивает медиа и отправляет пользователю результат. Дополнительно есть HTTP API для управления аккаунтами и сетками (grids). Документ служит внутренней справкой по функционалу, модульной архитектуре и правилам разработки.

## Базовые правила
- **Модульность**: код группируется по доменным зонам (бот, воркер, общие сервисы), без смешивания обязанностей.
- **Комментарии**: в коде только важные комментарии — поясняющие нетривиальные решения, ограничения или бизнес-правила. Очевидные вещи оставляем без комментариев.
- **Документация**: любые новые модули, публичные функции и изменения в потоках нужно отражать в этой документации и в README (если влияет на запуск/использование).

## Основные потоки
1. Пользователь отправляет ссылку в Telegram.
2. `tg_bot` определяет провайдера и кладёт Job в RQ.
3. `worker` получает Job, скачивает файл и отправляет пользователю.
4. HTTP API (`api`) предоставляет операции над аккаунтами и сетками, используя общие сервисы и хранилище.

## Модули и их ответственность

### `api/`
- FastAPI-приложение для операций с аккаунтами и сетками (grids).
- Использует `shared.services` и `shared.storage` для бизнес-логики и доступа к данным.
- Обрабатывает сервисные ошибки и возвращает соответствующие HTTP-статусы.

### `tg_bot/`
- Telegram-бот на aiogram v3.
- Детектирует провайдера по входящему тексту через `shared.router.detect`.
- Формирует Job и кладёт его в очередь RQ.
- Отдельные handlers регистрируются в `tg_bot.handlers`.

### `worker/`
- RQ-воркер, обрабатывающий Job.
- `worker.tasks` выбирает обработчик провайдера и отправляет результат через Telegram API.
- `worker.handlers` содержит обработчики провайдеров (YouTube, Instagram, VK).
- `worker.downloaders` содержит утилиты для скачивания и обработки медиа.
- `worker.scheduler`, `worker.scheduling`, `worker.cleanup` — фоновые задачи и периодические операции.

### `shared/`
Общий слой, который используют и бот, и воркер, и API:
- `shared.config` — загрузка настроек/переменных окружения.
- `shared.jobs` — модели Job и сериализация.
- `shared.providers` — провайдеры ссылок, нормализация URL и построение Job.
- `shared.router` — регистрация провайдеров и детектирование по тексту.
- `shared.services` — бизнес-логика (аккаунты, grids, расписания, события).
- `shared.storage` — слой доступа к БД (инициализация, запросы).
- `shared.models` — модели данных.

### `deploy/`
- Kubernetes-манифесты для деплоя.

### `Dockerfile.bot` / `Dockerfile.worker`
- Docker-образы для бота и воркера.

### `requirements.txt`
- Общий список Python-зависимостей.

## Как добавлять новые модули
1. Определить доменную область (например, новый провайдер, новый сервис, новая API-эндпойнт-группа).
2. Создать отдельный модуль с минимальными зависимостями.
3. Добавить описания в этот документ и (при необходимости) в README.
4. Для провайдеров: зарегистрировать в `shared.providers` и обработчик в `worker.handlers`.

## Контрольный список перед изменениями
- Архитектура остаётся модульной, ответственности не смешиваются.
- Комментарии добавлены только в местах, где это реально упрощает понимание.
- Документация обновлена (этот файл + README при необходимости).
